# Triage Integration Scenarios
# Tests transitions between classification, IVR navigation, and conversation
#
# These test the actual processor logic (events, state changes) without LLM calls.
#
# Usage:
#   python run.py --scenario <id>
#   python run.py --all
#   python run.py --list

dataset_name: "demo_clinic_alpha/eligibility_verification/triage/integration"
dataset_description: "Integration tests for triage transition flows"

scenarios:
  # =============================================================================
  # CLASSIFICATION → IVR
  # =============================================================================

  - id: "1"
    description: "Classification detects IVR and fires on_ivr_detected event"
    test_type: classification_to_ivr
    classifier_response: "IVR"
    expected_event: "on_ivr_detected"
    expected_decision_made: true

  - id: "2"
    description: "IVR detection passes conversation history to handler"
    test_type: classification_to_ivr_with_history
    classifier_response: "IVR"
    conversation_history:
      - role: "user"
        content: "Press 1 for claims, press 2 for eligibility"
    expected_event: "on_ivr_detected"
    expected_history_length: 1

  # =============================================================================
  # CLASSIFICATION → CONVERSATION
  # =============================================================================

  - id: "3"
    description: "Classification detects CONVERSATION and fires event"
    test_type: classification_to_conversation
    classifier_response: "CONVERSATION"
    expected_event: "on_conversation_detected"
    expected_decision_made: true

  - id: "4"
    description: "Human greeting triggers CONVERSATION with history"
    test_type: classification_to_conversation_with_history
    classifier_response: "CONVERSATION"
    conversation_history:
      - role: "user"
        content: "Hello, this is Jennifer from member services."
    expected_event: "on_conversation_detected"
    expected_history_length: 1

  # =============================================================================
  # CLASSIFICATION → VOICEMAIL
  # =============================================================================

  - id: "5"
    description: "Classification detects VOICEMAIL and sets flag"
    test_type: classification_to_voicemail
    classifier_response: "VOICEMAIL"
    expected_voicemail_detected: true
    expected_decision_made: true

  # =============================================================================
  # IVR NAVIGATION → CONVERSATION (completed)
  # =============================================================================

  - id: "6"
    description: "IVR completed status fires on_ivr_status_changed event"
    test_type: ivr_status
    ivr_status: "completed"
    expected_event: "on_ivr_status_changed"
    expected_status: "completed"
    expected_active: false

  - id: "7"
    description: "IVR stuck status fires event and deactivates"
    test_type: ivr_status
    ivr_status: "stuck"
    expected_event: "on_ivr_status_changed"
    expected_status: "stuck"
    expected_active: false

  - id: "8"
    description: "IVR wait status does NOT fire event, stays active"
    test_type: ivr_status
    ivr_status: "wait"
    expected_event: null
    expected_active: true

  # =============================================================================
  # DTMF NAVIGATION
  # =============================================================================

  - id: "9"
    description: "DTMF 1 fires on_dtmf_pressed event"
    test_type: dtmf
    dtmf_key: "1"
    expected_event: "on_dtmf_pressed"
    expected_key: "1"

  - id: "10"
    description: "DTMF star key works for back navigation"
    test_type: dtmf
    dtmf_key: "*"
    expected_event: "on_dtmf_pressed"
    expected_key: "*"

  - id: "11"
    description: "DTMF pound key works"
    test_type: dtmf
    dtmf_key: "#"
    expected_event: "on_dtmf_pressed"
    expected_key: "#"

  - id: "12"
    description: "Multiple DTMF presses all fire events"
    test_type: dtmf_sequence
    dtmf_sequence: ["1", "2", "3"]
    expected_events: 3
    expected_keys: ["1", "2", "3"]

  - id: "13"
    description: "DTMF then completed fires both events in order"
    test_type: dtmf_then_status
    dtmf_key: "2"
    ivr_status: "completed"
    expected_events:
      - event: "on_dtmf_pressed"
        value: "2"
      - event: "on_ivr_status_changed"
        value: "completed"

  # =============================================================================
  # EDGE CASES
  # =============================================================================

  - id: "14"
    description: "Gibberish classifier response fires no events"
    test_type: classification_edge
    classifier_response: "I don't understand"
    expected_event: null
    expected_decision_made: false

  - id: "15"
    description: "Classification only fires once (decision_made guard)"
    test_type: classification_only_once
    classifier_responses: ["CONVERSATION", "IVR"]
    expected_event: "on_conversation_detected"
    expected_event_count: 1

  - id: "16"
    description: "Classification is case insensitive"
    test_type: classification_edge
    classifier_response: "ivr"
    expected_event: "on_ivr_detected"
    expected_decision_made: true

  - id: "17"
    description: "Classification works with keyword embedded in text"
    test_type: classification_edge
    classifier_response: "Based on the greeting, this is a CONVERSATION with a human."
    expected_event: "on_conversation_detected"
    expected_decision_made: true

  # =============================================================================
  # FLOW INTEGRATION
  # =============================================================================

  - id: "18"
    description: "EligibilityVerificationFlow provides valid triage config"
    test_type: flow_config
    expected_keys:
      - "classifier_prompt"
      - "ivr_navigation_goal"
      - "voicemail_message"
    expected_in_classifier_prompt:
      - "CONVERSATION"
      - "IVR"
      - "VOICEMAIL"

  - id: "19"
    description: "Voicemail message includes patient and facility"
    test_type: voicemail_template
    patient_name: "Jane Smith"
    facility_name: "ABC Medical Center"
    expected_in_message:
      - "Jane Smith"
      - "ABC Medical Center"
